<!DOCTYPE html>
<html>
<head>
    <title>Read data from External JSON file using JavaScript</title>
    <meta charset="utf-8">
    <!-- https://www.encodedna.com/javascript/practice-ground/default.htm?pg=create_html_table_using_json_data_from_external_file -->

    <script type="application/javascript" src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>


<script>
    function add_testing_cell(app, tr, name) {
        var tabCell = tr.insertCell(-1);
        if (name in app["testing"]) {
            tabCell.innerHTML = app["testing"][name];
            if (app["testing"][name]) {
                tabCell.bgColor = "lime";
            } else {
                tabCell.bgColor = "red";
            }
        }
    }

    function add_app(app) {
        var table = document.getElementById("appTable");
        var tr = table.insertRow(-1);

        var tabCell = tr.insertCell(-1);
        if (app["type"] == "coin") {
            //'<img src="https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/twitter/282/coin_1fa99.png" width="24" height="24"/>'
            tabCell.innerHTML = "ü™ô";
        } else if (app["type"] == "dev") {
            tabCell.innerHTML = "üßë‚Äçüíª";
        } else  {
            tabCell.innerHTML = "?";
        }

        var tabCell = tr.insertCell(-1);
        tabCell.innerHTML = '<a href="' + app["repo"]["url"] + '">' + app["name"] + '</a>';

        tabCell = tr.insertCell(-1);
        tabCell.innerHTML = app["status"] == "unknown" ? "?" : app["status"];
        if (app["status"] == "reviewed") {
            tabCell.bgColor = "lime";
        }

        if ("testing" in app) {
            add_testing_cell(app, tr, "ci");
            add_testing_cell(app, tr, "scan-build");
            add_testing_cell(app, tr, "coverity");
            add_testing_cell(app, tr, "tests");
            add_testing_cell(app, tr, "fuzzing");
        } else {
            tr.insertCell(-1);
            tr.insertCell(-1);
            tr.insertCell(-1);
            tr.insertCell(-1);
            tr.insertCell(-1);
        }

    }

    function retrieve_app(url) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", url, true);
        xhr.onload = function (e) {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              //console.log(xhr.responseText);
              const jsonData = jsyaml.load(xhr.responseText);
              //console.log(jsonData);
              add_app(jsonData);
            } else {
              console.log("failed to retrieve app at " + url);
              console.error(xhr.statusText);
            }
          }
        };
        xhr.onerror = function (e) {
          console.error(xhr.statusText);
        };
        xhr.send(null);
    }

    function retrieve_apps_list() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "https://api.github.com/repos/ledgerhq/apps-dashboard/contents/apps/", true);
        xhr.onload = function (e) {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                var data = xhr.responseText;
                var json = JSON.parse(data);
                var urls = json.map(function (x) { return x["download_url"]; }, data);
                urls.map(retrieve_app);
            } else {
              console.log("failed to retrieve apps list");
              console.error(xhr.statusText);
            }
          }
        };
        xhr.onerror = function (e) {
          console.error(xhr.statusText);
        };
        xhr.send(null);
    }

    function main() {
        retrieve_apps_list();
    }
</script>

    <style>
       div { font:17px 'Calibri'; }

        table, th, td {
            border: solid 1px #ddd;
            border-collapse: collapse;
            padding: 2px 3px;
            text-align: left;
        }
        th {
            font-weight:bold;
        }
    </style>
</head>
<body>
    <div id="blah">
      <table id="appTable">
        <tbody>
          <tr><th>Type</th><th>Name</th><th>Status</th><th>CI</th><th>Scan-build</th><th>Coverity</th><th>Tests</th><th>Fuzzing</th></tr>
        </tbody>
      </table>
    </div>

    <script>main();</script>
</body>
</html>
